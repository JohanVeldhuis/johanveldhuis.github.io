---
id: 2203
title: A closer look at the Database One Copy Alert scheduled task
date: 2011-05-20T20:06:25+00:00
author: Johan Veldhuis
layout: post
guid: http://johanveldhuis.nl/?p=2203
permalink: /a-closer-look-at-the-database-one-copy-alert-scheduled-task/
categories:
  - Exchange
---
Starting from Exchange 2010 SP1 a scheduled task called _Database One Copy Alert_ will be configured automatically on each mailbox server. This script will be executed every hour and will check if multiple copies are available inside the DAG. Besides this the status of the copy will be checked. This because a copy which is not healthy may lead to data lost during a failover.

[<img title="Scheduled task" src="https://i1.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture22-300x23.jpg?resize=300%2C23" alt="" width="300" height="23" data-recalc-dims="1" />](https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture22.jpg)

The scheduled task will execute the_CheckDatabaseRedundancy.ps1_ script which can be found in the _scripts_ directory of your Exchange installation. But what if you don&#8217;t have a DAG in you Exchange environment? In this case no alert will be send.

Besides running the script automatically it&#8217;s also possible to run it manually.

[<img title="Run CheckDatabaseRedundacy.ps1" src="https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture-300x34.jpg?resize=300%2C34" alt="" width="300" height="34" data-recalc-dims="1" />](https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture.jpg)

In the screenshot above you will see what the output is of a script ran on an Exchange server which is not a member of a DAG.Â  In this case no check will be performed. As you can see it&#8217;s possible to send an alert via e-mail.

When having a DAG a lot of information will be displayed. For example are there multiple database copies but also what&#8217;s the status of the database.

An event generated by the script can have two levels:

  * red, there are not enough copies available from the database, or the copy of the database does not have the status _healthy._ In this case an event will be logged with event ID 4113
  * green, there are multiple copies of a database and the copy has the status _healthy._ In this case an event will be logged with event ID 4114_
  
_ 

In the first case this requires some action. There is one remark which must be made about the red level. This level will be assigned only if the issues still exists after 20 minutes. When a problem is detected the script will perform an itteration several times. One itteration is done every minute, if after 20 minutes the level is still red an event will be written to the event log. Once this has been done an event will be written in the event log every 15 minutes till the level is green again. But before a level is changed back to green the script will wait 10 itterations (10 minutes). If you would like to receive the status per mail when the alert level has changed to red for one of the databases you will need to modify the scheduled task

By default the scheduled task will be executed using the following parameters:

_-NonInteractive -WindowStyle Hidden -command &#8220;& &#8216;C:\Program Files\Microsoft\Exchange Server\V14\Scripts\CheckDatabaseRedundancy.ps1&#8217; -MonitoringContext -ShowDetailedErrors -ErrorAction:Continue&#8221;_

When you change this to:

_-NonInteractive -WindowStyle Hidden -command &#8220;& &#8216;C:\Program Files\Microsoft\Exchange Server\V14\Scripts\CheckDatabaseRedundancy.ps1&#8242; -MonitoringContext -ShowDetailedErrors -ErrorAction:Continue -SummaryMailFrom:&#8217;exchange02.corp.local&#8217;-SendSummaryMailTos:@(&#8216;administrator@corp.local&#8217;)&#8221;_

The script will send an e-mail with detailed information once there is an issue.

[<img title="Red Alert" src="https://i2.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/capture4-300x148.jpg?resize=300%2C148" alt="" width="300" height="148" data-recalc-dims="1" />](https://i2.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/capture4.jpg)

In the example above you will see that there is an issue with the database in our DAG. There is only one copy of the specific database which will result in no mailbox access after the server fails.

[<img title="Database in sync" src="https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture5-300x96.jpg?resize=300%2C96" alt="" width="300" height="96" data-recalc-dims="1" />](https://i1.wp.com/johanveldhuis.nl/wp-content/uploads/2011/05/Capture5.jpg)

When adding an additional database copy and rerunning the script you will see the status has changed from red to green. If the copy with the preference of 1 fails then the database with preference 2 will be actived.

The script can be executed using some parameters. In the table below an overview is displayed of these parameters and a description of them:

[table id=21 /]

For more information you can have a look at the page below. One remark should be made that the mentioned page describes the script which could be used in Exchange 2010 RTM. Starting from Exchange 2010 SP1 the script is installed during the Exchange installation by default:

The Exchange Team Blog: RELEASED: Exchange 2010 Database Redundancy Check Script: <a href="http://blogs.technet.com/b/exchange/archive/2010/05/20/3409984.aspx" target="_blank">open</a>