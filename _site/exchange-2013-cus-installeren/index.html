<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Deploy Exchange 2013 CU&#8217;s</title>
	
	<meta name="author" content="Johan Veldhuis">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/dbtek">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/jveldh">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:johan@myuclab.nl">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f?s=35" class="img-circle" />
				Johan&#039;s Web Portal
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="/about.html"><i class="fa fa-eye"></i>About</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">Johan&#039;s Web Portal</a>
    </h3>
</header>



<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/dbtek">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/jveldh">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:johan@myuclab.nl">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Deploy Exchange 2013 CU&#8217;s </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   August 
	   3rd,
	     
	   2013
	 </span>
	  <div class="article_body">
	  <p>This weeks the second version of the second cumulative update has been released for Exchange 2013. As you may already know Microsoft has changed his update process completely with the introduction of Exchange 2013. No more rollups and only cumulative updates (CU’s).</p>

<p>A pretty big change as the CU’s require you to make changes to the AD also as step of the update process. For those not familiar with rollups of Exchange 2010, the rollups where just bit updates and did not include AD changes. In Exchange 2010 the AD changes where only included in service packs.</p>

<p>CU’s are a complete install of Exchange 2013. So if you plan to install Exchange 2013 in the future you will only need to install the latest CU and you’re done.</p>

<p>But what has changed from deployment standpoint? Well pretty much because we now have to think of the Managed Availability feature of Exchange 2013. This feature will continually monitor the environment and takes action if necessary.</p>

<p>You can compare it with placing a node in maintenance mode in a load balancer. Although with placing a node in maintenance mode in a load balancer only ensures that it doesn’t offer any traffic anymore to the specific server.</p>

<p>Managed availability goes steps further, it can do this because the monitors contain knowledge about the product something load balancers don’t have.</p>

<p>For changing the status of the components on a server you will need to use the <em>Set-ServerComponentState</em> cmdlet. Using this cmdlet with the necessary parameters you can influence the components of a server.</p>

<p>Which components are active on a server depends on which roles are deployed to  server. To find out which components are available on a server you can run <em>Get-ServerComponentState</em>. In the example below you will see an output example of a multi-role Exchange 2013 server:</p>

<p><a href="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate.png"><img alt="get-servercomponentstate" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-300x122.png?resize=300%2C122" width="300" height="122" data-recalc-dims="1" /></a></p>

<p>As you can see all components are up and running. Let’s assume that we have prepared our AD and are now ready to deploy the bits on our Exchange 2013 servers.</p>

<p>Our environment consists of two Exchange 2013 multirole servers. A third server is used as the File Share Witness (FSW) to maintain quorum.</p>

<p><a href="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline.png"><img alt="get-servercomponentstate serverwideoffline" src="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline-300x124.png?resize=300%2C124" width="300" height="124" data-recalc-dims="1" /></a></p>

<p>The first step will me to ensure that the transport queues will be empty before continuing the process. Using the S_et-ServerComponentState_ cmdlet we can set the status of a component. Besides the status we will need to provide the requestor. In this case the requestor we are going to use is <em>maintenance.</em></p>

<p><em>Set-ServerComponentState –identity ex02 –component –state draining –requestor  maintenance<a href="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline.png"><img alt="get-servercomponentstate serverwideoffline" src="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline-300x124.png?resize=300%2C124" width="300" height="124" data-recalc-dims="1" /></a></em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/hub_draining.png"><img alt="hub_draining" src="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/hub_draining-300x15.png?resize=300%2C15" width="300" height="15" data-recalc-dims="1" /></a></p>

<p>By using the cmdlet above we will put the transport component in draining state. This means it will take care of the messages which are currently in the queue but will not accept any new messages.</p>

<p>You can speed up the process by moving the messages to a transport component hosted on another server. To do this you will need to use the <em>move-messages</em> cmdlet:</p>

<p><em>Redirect-Messages -server ex02 –targetserver ex01.corp.local</em></p>

<p><a href="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/redirect-message.png"><img alt="redirect-message" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/redirect-message-300x45.png?resize=300%2C45" width="300" height="45" data-recalc-dims="1" /></a></p>

<p>To check if the queues are empty we can use the good old <em>get-queue</em> cmdlet:</p>

<p><em>Get-Queue –server ex02</em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/queue.png"><img alt="queue" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/queue-300x27.png?resize=300%2C27" width="300" height="27" data-recalc-dims="1" /></a></p>

<p>If all queues are clean we can continue with disabling all the other components which are active on the server:</p>

<p><em>Set-ServerComponentState –identity ex02 –component serverwideoffline –state inactive –requestor maintenance</em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore-hub.png"><img alt="set-servcomponentstat serverwideoffline restore hub" src="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore-hub-300x9.png?resize=300%2C9" width="300" height="9" data-recalc-dims="1" /></a></p>

<p>To verify if all components are set to the status inactive we could run the <em>Get-ServerComponentState</em> cmdlet again:</p>

<p><a href="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline.png"><img alt="get-servercomponentstate serverwideoffline" src="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate-serverwideoffline-300x124.png?resize=300%2C124" width="300" height="124" data-recalc-dims="1" /></a></p>

<p>Now all components are inactive it’s time to handle the database availability group (DAG) part.</p>

<p>There are a two ways to put a DAG member in maintenance mode. Those who are familiar with Exchange 2010 will remember the s_tart-dagmaintenance_ script which will help you in putting s DAG member in maintenance model Well good news the script is still available and can be found in the same location as in Exchange 2010, the Exchange scripting directory.</p>

<p>Another method to put  DAG member in maintenance mode is to set the status of the cluster component using the <em>Suspend-ClusterNode,</em> for example:</p>

<p><em>Suspend-ClusterNode</em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/suspend-clusternode.png"><img alt="suspend-clusternode" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/suspend-clusternode-300x56.png?resize=300%2C56" width="300" height="56" data-recalc-dims="1" /></a></p>

<p>Once the cluster node has been stopped you will need to prevent the databases from being moved d on the member:</p>

<p><em>Set-MailboxServer  -Identity ex02-DatabaseCopyActivationDisabledAndMoveNow $trueSet-MailboxServer  -DatabaseCopyAutoActivationPolicy Blocked</em></p>

<p><a href="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-mailboxserver-activation.png"><img alt="set-mailboxserver activation" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-mailboxserver-activation-300x11.png?resize=300%2C11" width="300" height="11" data-recalc-dims="1" /></a></p>

<p>And as final step we want to set the auto activation policy temporarily to blocked:</p>

<p><em>Set-MailboxServer  -Identity ex02 -DatabaseCopyAutoActivationPolicy Blocked</em></p>

<p>Now all prerequired steps have been taken it is time to kick of the setup. In this blog we will use the cmdline to update our Exchange 2013 server. To update the server start the setup using the following parameters:</p>

<p><em>Setup.exe /m:upgrade /IacceptExchangeServerLicensing</em></p>

<p>This will start the upgrade to CU2 as you can see below:</p>

<p><a href="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/accept-license.png"><img alt="setup.exe /m:upgrade" src="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/accept-license-300x15.png?resize=300%2C15" width="300" height="15" data-recalc-dims="1" /></a></p>

<p>Once the setup has finished you might decide to reboot the server. Once the server is back online it is time to restore the services.</p>

<p>To restore the services we will need need to perform the steps mentioned earlier only then in reverse order.</p>

<p>So we will start with putting the DAG member back online:</p>

<p>First we will make the DAG member and active of part of the cluster again:</p>

<p><em>Resume-ClusterNode</em></p>

<p>Once this has been done we need to remove the limits for database failovers which we configured earlier:</p>

<p><em>Set-MailboxServer  -Identity ex02-DatabaseCopyActivationDisabledAndMoveNow $trueSet-MailboxServer  -DatabaseCopyAutoActivationPolicy Blocked</em></p>

<p><em>Set-MailboxServer  -Identity ex02 -DatabaseCopyAutoActivationPolicy Blocked</em></p>

<p><a href="https://i2.wp.com/myuclab.nl/wp-content/uploads/2013/07/resume-clusternode.png"><img alt="resume-clusternode" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/resume-clusternode-300x45.png?resize=300%2C45" width="300" height="45" data-recalc-dims="1" /></a></p>

<p>Now our DAG member is back online we need to change the component states to active:</p>

<p><em>Set-ServerComponentStatus –identity ex02 –component serverwideoffline –status active –requestor maintenance</em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore.png"><img alt="set-servcomponentstat serverwideoffline restore" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore-300x22.png?resize=300%2C22" width="300" height="22" data-recalc-dims="1" /></a></p>

<p>When running the <em>Get-ServerComponentStatus</em> cmdlet you will see that the status of the transport component is still <em>draining</em>.</p>

<p>To stop the draining process for the transport component we will need to run the <em>Set-ServerComponentStatus</em> cmdlet again only using a different <em>action</em> parameter:</p>

<p><em>Set-ServerComponentStatus –identity ex02 –component transport –status active –requestor maintenance</em></p>

<p><a href="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore-hub1.png"><img alt="set-servcomponentstat serverwideoffline restore hub" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/set-servcomponentstat-serverwideoffline-restore-hub1-300x9.png?resize=300%2C9" width="300" height="9" data-recalc-dims="1" /></a></p>

<p>Now when running the <em>Get-ServerComponent</em> cmdlet again the status of each component should show <em>active.</em></p>

<p><a href="https://i1.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate_fullrestore.png"><img alt="get-servercomponentstate_fullrestore" src="https://i0.wp.com/myuclab.nl/wp-content/uploads/2013/07/get-servercomponentstate_fullrestore-300x143.png?resize=300%2C143" width="300" height="143" data-recalc-dims="1" /></a></p>

<p>Here ends the blog about how to install a CU on an Exchange 2013 server. If you hate to type the cmdlets manually then have a look at this script from Michael van Hoorenbeeck:</p>

<p>Micheals script: <a href="http://michaelvh.wordpress.com/2013/04/08/script-putting-exchange-server-2013-into-maintenance-mode/" target="_blank">open</a></p>

<p>The script will perform the same cmdlets only with less typing for your and will simplify the proces of putting a server in maintenance and restore the services again.</p>

	  </div>
		
		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Exchange 2013-ref">
					Exchange 2013 <span>(19)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<h4>Comments</h4>
		
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'johanveldhuis';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Deploy Exchange 2013 CU&#8217;s&via=jveldh"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f" class="img-rounded author-image" />
        <h4 class="section-title author-name">Johan Veldhuis</h4>
        <p class="author-bio"></p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/congratulations-2013-microsoft-mvp/" title="Congratulations 2013 Microsoft MVP!">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/sefautil-gui/" title="SefaUtil GUI">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2019 Johan Veldhuis with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'johanveldhuis', 'auto');
  ga('send', 'pageview');
</script>

