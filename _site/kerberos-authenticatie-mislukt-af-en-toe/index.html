<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Kerberos authentication fails sporadically</title>
	
	<meta name="author" content="Johan Veldhuis">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/dbtek">
				<i class="fa fa-github"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="http://twitter.com/jveldh">
				<i class="fa fa-twitter"></i>
			</a>
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:johan@johanveldhuis.nl">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f?s=35" class="img-circle" />
				Johan&#039;s Web Portal
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li><a href="/about.html"><i class="fa fa-eye"></i>About</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f?s=150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">Johan&#039;s Web Portal</a>
    </h3>
</header>



<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/dbtek">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://twitter.com/jveldh">
				<i class="fa fa-twitter fa-lg"></i>
			</a>
		</li>
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:johan@johanveldhuis.nl">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>Kerberos authentication fails sporadically </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   December 
	   16th,
	   
	   2011
	 </span>
	  <div class="article_body">
	  <p>Earlier this year a <a href="http://blogs.technet.com/b/exchange/archive/2011/04/15/recommendation-enabling-kerberos-authentication-for-mapi-clients.aspx?ocid=aff-n-we-loc--ITPRO40890&amp;WT.mc_id=aff-n-we-loc--ITPRO40890">blog</a> on the Exchange Team site was poste by Ross Smith IV. In this blog he encouraged to use Kerberos as authentication method for Outlook clients.</p>

<p>In a lot of Exchange environments you will see that it is implemented. When you are using a CAS Array you will need to create an alternate service account (ASA) for this. This can be done by using the  <a href="http://technet.microsoft.com/en-us/library/ff808311.aspx?ocid=aff-n-we-loc--ITPRO40890&amp;WT.mc_id=aff-n-we-loc--ITPRO40890">RollAlternateserviceAccountPassword.ps1</a> script. Keep in mind that when using the <em>CreateScheduledTask</em> parameter the scheduled task will run as the account who created the scheduled task.</p>

<p>After registering the correct SPN’s on the ASA account Kerberos will work in most cases. In some scenario’s a typo is made which results in incorrect SPN’s being registered. When this is the case you can solve it by using <a href="http://technet.microsoft.com/nl-nl/library/cc755413(WS.10).aspx?ocid=aff-n-we-loc--ITPRO40890&amp;WT.mc_id=aff-n-we-loc--ITPRO40890">setspn</a> or AdsiEdit.</p>

<p>But what if Kerberos sometimes works and sometimes not, or does only work for specific users?  If it doesn’t work a user will not be able to access his/her mailbox.</p>

<p>The easiest way to figure out if Kerberos is to change the Outlook profile.</p>

<p><a href="https://i2.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/Outlook-security-tab.jpg"><img title="Outlook security tab" src="https://i1.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/Outlook-security-tab-243x300.jpg?resize=243%2C300" alt="" width="243" height="300" data-recalc-dims="1" /></a></p>

<p>On the <em>security</em> tab of the account you will need to change the value of <em>Logon network security _to _NTLM.</em> If the user can access his/her mailbox after this you know that Kerberos is causing the issue.</p>

<p>Besides this an event will be logged in the <em>system event log</em>. Because a small set of logging is enabled on the Windows Servers you won’t see the Kerberos issue on that side. To enabled the logging you will need to make a change in the registry:</p>

<ul>
  <li>start <em>regedit</em></li>
  <li>browse to <em>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Kerberos\Parameters</em></li>
  <li>create a Dword called <em>LogLevel</em></li>
  <li>change the value of the Dword to <em>0x1</em></li>
</ul>

<p>Logging is directly enabled after creating the registry key and after a refresh you will see several Kerberos errors in the log.</p>

<p>Another option is to create a network trace using <a href="http://www.wireshark.org/download.html">Wireshark</a> or <a href="http://www.microsoft.com/download/en/details.aspx?id=4865">Netmon</a>. In both cases you will see the following message in the trace:</p>

<p><em>0xD – KDC_ERR_BADOPTION: KDC cannot accommodate requested option</em></p>

<p>When you will search the internet for this error you will see you are not the only one. But let’s start from the begin instead of going to directly to the solution.</p>

<p>One of the first things you will need to do is run <em>SetSPN -L “ASA account”</em>  to verify that all correct SPN’s are registered. The SPN’s should be unique. Despite I have seen environments where the domain controllers also contain two SPN’s named <em>ExchangeAB _followed by the netbios and fqdn. To verify if the SPN’s are unique you can use _SetSPN -Q “SPN VALUE”</em> , for example <em>SetSPN -Q ExchangeAB/*</em>.</p>

<p><a href="https://i1.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/setspn-q.jpg"><img title="setspn -q" src="https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/setspn-q-300x241.jpg?resize=300%2C241" alt="" width="300" height="241" data-recalc-dims="1" /></a></p>

<p>As displayed in the screenshot above you will see ExchangeAB will be found four times. Two times on the Exchange Server and two times on the DC.</p>

<p>As fas as we can see at this moment everything looks OK. Time to continue troubleshooting. But with which step can you continue when you have the error above? Klist.exe or Kerbtray.exe will not help a lot because in most cases renewing the tickets won’t solve the issue.</p>

<p>After some research together with a customer we found the root cause of the issue.</p>

<p>Microsoft did change the UDP packet size starting from Windows 2003. In Windows XP the UDP packet size was set to 2000, starting from 2003 it has been set to 1465. I think you know what will happen when Kerberos will send a package. Kerberos will use UDP by default . This will result in incompleted packages which will arrive at servers containing Windows 2003 or above as OS.</p>

<p>But why does the issue only happens for some users? This depends on the Kerberos ticket size. The size of a Kerberos ticket is determind by:</p>

<ul>
  <li>length of the password</li>
  <li>membership of groups</li>
  <li>do the groups contain other nested groups</li>
</ul>

<p>To solve this issue you will need to make a registry change:</p>

<ul>
  <li>start <em>regedit</em></li>
  <li>browse to HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa\ Kerberos\Parameters</li>
  <li>create a Dword called <em>MaxPacketSize</em></li>
  <li>change the value of the Dword to <em>1</em></li>
</ul>

<p>By making this change all Kerberos packages which are bigger then 1K will be send by using Kerberos over TCP.</p>

<p>Restart the computer and change the Outlook profile to <em>Negotiate Authentication</em>. Verify if you can access the mailbox. Using klist.exe or kerbtray.exe verify of the tickets will be created correctly. Both tools are part of the <a href="http://www.microsoft.com/download/en/details.aspx?id=17657?ocid=aff-n-we-loc--ITPRO40890&amp;WT.mc_id=aff-n-we-loc--ITPRO40890">resource kit </a>for Windows 2003. In Windows 7 and 2008 klist is a part of the OS.</p>

<p><a href="https://i1.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/Kerberos-tickes.jpg"><img title="Kerberos tickets" src="https://i0.wp.com/johanveldhuis.nl/wp-content/uploads/2011/12/Kerberos-tickes-300x121.jpg?resize=300%2C121" alt="" width="300" height="121" data-recalc-dims="1" /></a></p>

<p>In this screenshot two Kerberos tickets are listed which are being used by Exchange. If all authentication is performed by using Kerberos you will see the following Kerberos tickets:</p>

<ul>
  <li>exchangeMDB</li>
  <li>exchangeRFR</li>
  <li>exchangeAB</li>
  <li>http</li>
</ul>

<p>When you will look in the event log of the client you won’t find any Kerberos messages.</p>

<p>Microsoft has published a complete document about troubleshooting Kerberos authentication issues. You can find the document <a href="http://www.microsoft.com/download/en/details.aspx?displaylang=en&amp;id=21820">here</a>.</p>

	  </div>
		
		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Blog-ref">
					Blog <span>(132)</span>
					
				</a></li>
			
		  
		</ul>
		  

		  

		<hr>

		<h4>Comments</h4>
		
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'johanveldhuis';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=Kerberos authentication fails sporadically&via=jveldh"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/8209ff9e4ba94ac3058e69fd75354b3f" class="img-rounded author-image" />
        <h4 class="section-title author-name">Johan Veldhuis</h4>
        <p class="author-bio"></p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/deploying-the-barracuda-load-balancer-with-microsoft-exchange-server-2010-de-ontbrekende-handleiding/" title="Deploying the Barracuda Load Balancer with Microsoft Exchange Server 2010 – the missing manual">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/wat-gebeurde-er-in-2011-met-exchange-2010/" title="What happened to Exchange 2010 in 2011">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2019 Johan Veldhuis with <a href="http://jekyllrb.com/">Jekyll</a>. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'johanveldhuis', 'auto');
  ga('send', 'pageview');
</script>

